<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ngetik Gabut Minimalis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Gaya dasar dan font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; /* HAMPIR HITAM untuk DARK MODE MURNI */
            color: #e0e0e0; /* Teks lebih terang */
            min-height: 100vh;
        }
        /* Styling tambahan untuk area mengetik */
        #quote-display {
            background-color: #1e1e1e; 
            color: #e0e0e0;
            padding: 1.5rem;
            border-radius: 0.75rem; 
            font-size: 1.15rem; 
            line-height: 1.8;
            text-align: justify;
            min-height: 8rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); 
            word-break: normal;
            white-space: normal;
            overflow-wrap: break-word; 
            word-wrap: break-word; 
            border: 1px solid #333333; 
        }
        /* Memastikan seluruh kata (yang terdiri dari banyak span.char) tidak terpotong di tengah */
        .word {
            white-space: nowrap; 
            display: inline; 
        }
        /* Efek visual untuk mengetik */
        .char {
            transition: color 0.1s, background-color 0.1s; 
        }
        .correct { 
            color: #2ecc71; 
        }
        .incorrect { 
            background-color: #e74c3c; 
            color: #121212; 
            border-radius: 2px; 
            box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
        }
        /* Penanda posisi kursor */
        .current { 
            border-bottom: 3px solid #3498db; 
            padding-bottom: 2px;
        }
        /* TextArea */
        #quote-input {
            font-family: monospace;
            font-size: 1.1rem;
            outline: none;
            box-sizing: border-box;
            resize: none;
            background-color: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #333333;
        }
        #quote-input:focus {
             border-color: #3498db;
        }
        /* Gaya overlay manajemen untuk mobile/tablet agar menutupi penuh */
        .management-overlay {
            background-color: #121212;
        }
        /* Styling untuk tombol di dark mode minimalis */
        .minimal-button {
            transition: all 0.2s;
        }
        .minimal-button:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="p-4 md:p-10">

<div id="alertContainer" class="fixed top-4 right-4 z-50">
    </div>

<div id="mainContainer" class="max-w-5xl mx-auto">
    
    <div id="typing-panel-content" class="bg-[#1e1e1e] p-8 rounded-2xl shadow-2xl relative border border-[#333333]">
        <div class="flex justify-end items-start mb-8">
            <button id="toggleManagementBtn" onclick="toggleManagementPanel()" 
                    class="p-3 bg-[#333333] hover:bg-[#444444] rounded-full text-gray-400 transition duration-200 shadow-md transform hover:rotate-12 minimal-button">
                <i class="fas fa-cog fa-lg"></i>
            </button>
        </div>
        
        <div id="quote-display" class="mb-8 mt-2">
            Memuat teks dari database...
        </div>
        
        <textarea id="quote-input" 
                  placeholder="Mulai ngetik di sini..." 
                  oninput="processInput()" 
                  class="w-full h-28 p-4 text-white border-2 rounded-lg transition duration-200" 
                  disabled></textarea>

        <div id="status-message" class="text-center text-gray-500 mt-6">
             Menunggu teks dari database...
        </div>
        
    </div>

    <div id="management-panel" class="bg-[#1e1e1e] p-8 rounded-2xl shadow-2xl hidden border border-[#333333]">
        <h2 class="text-3xl font-bold text-[#2ecc71] mb-8 flex justify-between items-center">
            Atur Teks Gabut
            <button onclick="toggleManagementPanel()" class="p-3 text-gray-400 hover:text-white rounded-full hover:bg-[#333333] minimal-button">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </h2>
        
        <div class="mb-10 p-6 bg-[#282828] rounded-xl shadow-md border border-[#333333]">
            <h3 class="text-xl font-semibold mb-4 text-[#e0e0e0]">Tambah Teks Baru</h3>
            <textarea id="newText" 
                      placeholder="Masukkan teks baru untuk ngetik (min. 10 karakter)..." 
                      class="w-full h-24 p-3 text-[#e0e0e0] border-2 border-[#333333] bg-[#1e1e1e] rounded-lg focus:border-[#2ecc71] transition duration-200 resize-none"></textarea>
            <button onclick="addText()" class="w-full bg-[#2ecc71] hover:bg-[#27ae60] text-white font-bold py-3 px-4 rounded-xl mt-4 transition duration-200 minimal-button">
                <i class="fas fa-plus mr-2"></i> Simpan Teks (Agar Ada Bahan Gabut)
            </button>
        </div>

        <div>
            <h3 class="text-xl font-semibold mb-4 text-[#e0e0e0]">Bahan Gabut Tersimpan (<span id="textCount">0</span>)</h3>
            <p class="text-sm text-gray-500 mb-4">Hapus jika sudah bosan mengetiknya.</p>
            <ul id="quotesList" class="max-h-96 overflow-y-auto pr-2">
                </ul>
        </div>
    </div>

</div>

<script type="module">
    // Import modul Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // --- 1. Konfigurasi dan Inisialisasi Firebase ---

    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
      apiKey: "AIzaSyBHpRt8cs00RI3rRcELKhkYRID5svpSZoY",
      authDomain: "myyg4m5.firebaseapp.com",
      databaseURL: "https://myyg4m5-default-rtdb.firebaseio.com",
      projectId: "myyg4m5",
      storageBucket: "myyg4m5.firebasestorage.app",
      messagingSenderId: "204097552587",
      appId: "1:204097552587:web:bd2dbb5d2c02c342fc5b4e"
    }));

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const textsRef = ref(db, 'user_texts'); 
    
    let allQuotes = []; 
    let timer = null; 
    let quoteToType;
    // VARIABEL BARU: Menyimpan teks yang terakhir digunakan
    let lastQuoteText = ""; 
    
    const quoteDisplay = document.getElementById('quote-display');
    const quoteInput = document.getElementById('quote-input');
    const typingPanelContent = document.getElementById('typing-panel-content');
    const managementPanel = document.getElementById('management-panel'); 
    const statusMessage = document.getElementById('status-message'); 

    // --- 2. Fungsi Utilitas UI ---

    const alertMessage = (message, type = 'info') => {
        const alertContainer = document.getElementById('alertContainer');
        const bgColor = type === 'success' ? 'bg-[#2ecc71]' : type === 'error' ? 'bg-[#e74c3c]' : 'bg-[#3498db]';
        const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle';

        const alertDiv = document.createElement('div');
        alertDiv.className = `flex items-center ${bgColor} text-white text-sm font-bold px-4 py-3 rounded-lg shadow-lg mb-2`;
        alertDiv.innerHTML = `<i class="fas ${icon} mr-3"></i> ${message}`;
        
        alertContainer.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    };
    
    window.toggleManagementPanel = () => {
        const isManagementHidden = managementPanel.classList.contains('hidden');

        if (isManagementHidden) {
            managementPanel.classList.remove('hidden');
            typingPanelContent.classList.add('hidden');
            managementPanel.classList.add('management-overlay'); 
        } else {
            managementPanel.classList.add('hidden');
            typingPanelContent.classList.remove('hidden');
            managementPanel.classList.remove('management-overlay'); 
        }
    };


    // --- 3. Fungsi Manajemen Teks Firebase (CRUD) ---

    window.addText = async () => {
        const newTextarea = document.getElementById('newText');
        const newText = newTextarea.value.trim();
        
        if (newText.length > 10) { 
            try {
                await push(textsRef, { text: newText, created: Date.now() });
                newTextarea.value = '';
                alertMessage('Teks berhasil ditambahkan!', 'success');
            } catch (error) {
                console.error("Gagal menambahkan teks:", error);
                alertMessage('Gagal menambahkan teks.', 'error');
            }
        } else {
            alertMessage('Teks harus memiliki minimal 10 karakter.', 'info');
        }
    };

    window.deleteText = async (id) => {
        alertMessage('Menghapus teks...', 'info'); 
        
        try {
            const itemRef = ref(db, `user_texts/${id}`); 
            await remove(itemRef);
            alertMessage('Teks berhasil dihapus!', 'success');
        } catch (error) {
            console.error("Gagal menghapus teks:", error);
            alertMessage('Gagal menghapus teks.', 'error');
        }
    };

    // Memuat Teks (Real-time Listener)
    const loadTexts = () => {
        const quotesList = document.getElementById('quotesList');
        const textCountDisplay = document.getElementById('textCount');

        onValue(textsRef, (snapshot) => {
            allQuotes = []; 
            const data = snapshot.val();
            quotesList.innerHTML = ''; 

            if (data) {
                Object.keys(data).forEach(key => {
                    const quoteText = data[key].text;
                    allQuotes.push({ id: key, text: quoteText }); 

                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-3 bg-[#121212] hover:bg-[#282828] transition duration-150 rounded-lg mb-2 border border-[#333333]';
                    li.innerHTML = `
                        <span class="text-sm text-gray-300 flex-1 mr-4 overflow-hidden truncate">${quoteText}</span>
                        <button onclick="deleteText('${key}')" class="text-[#e74c3c] hover:text-white transition duration-150 p-2 rounded-full hover:bg-[#333333] minimal-button">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    quotesList.appendChild(li);
                });
            } else {
                 quotesList.innerHTML = '<li class="text-gray-500 p-3 text-center">Belum ada bahan gabut tersimpan. Silakan tambah teks baru!</li>';
            }
            
            textCountDisplay.textContent = allQuotes.length;

            // Logika AUTO-START
            if (allQuotes.length > 0) {
                 quoteInput.disabled = false;
                 statusMessage.textContent = 'Mulai ketik, teks akan berganti otomatis setelah selesai.';
                 if (!quoteToType) startGame(); 
            } else {
                 quoteInput.disabled = true;
                 quoteDisplay.innerHTML = '<span class="text-[#e74c3c]">Tidak ada teks untuk diketik. Tambahkan teks di panel Atur Teks Gabut.</span>';
                 statusMessage.textContent = 'Gagal memuat teks. Silakan cek panel Atur Teks Gabut.';
            }
        }, (error) => {
            console.error("Gagal membaca data dari Firebase:", error);
            quoteDisplay.innerHTML = '<span class="text-[#e74c3c]">Gagal memuat teks dari database. Periksa koneksi dan aturan keamanan.</span>.';
            quoteInput.disabled = true;
            statusMessage.textContent = 'Gagal memuat teks dari database.';
        });
    };
    
    loadTexts();

    // --- 4. Logika Tes Mengetik (Mode Santai dan Loop) ---
    
    const getRandomQuote = () => {
        if (allQuotes.length === 0) return "Tidak ada teks yang tersedia.";
        
        let newQuote;
        let randomIndex;
        
        // LOGIKA PERBAIKAN: Loop sampai mendapatkan teks yang berbeda, kecuali hanya ada 1 teks.
        if (allQuotes.length > 1) {
            do {
                randomIndex = Math.floor(Math.random() * allQuotes.length); 
                newQuote = allQuotes[randomIndex].text; 
            } while (newQuote === lastQuoteText);
        } else {
            // Jika hanya ada 1 teks, gunakan teks itu
            newQuote = allQuotes[0].text;
        }

        // Simpan teks yang baru dipilih sebagai teks terakhir
        lastQuoteText = newQuote;
        return newQuote; 
    };

    const loadQuote = () => {
        quoteToType = getRandomQuote();
        
        const tokens = quoteToType.match(/(\S+|\s)/g) || []; 

        quoteDisplay.innerHTML = tokens.map(token => {
            if (token === ' ') {
                return `<span class="char">&nbsp;</span>`;
            } else {
                const wordSpans = token.split('').map(char => {
                    return `<span class="char">${char}</span>`; 
                }).join('');
                return `<span class="word">${wordSpans}</span>`;
            }
        }).join('');
    };

    const startGame = () => {
        if (allQuotes.length === 0) return;

        loadQuote();
        quoteInput.value = '';
        quoteInput.disabled = false;
        quoteInput.focus();
        
        if (timer) clearInterval(timer);
        timer = null;
        
        statusMessage.textContent = 'Sedang asyik mengetik...';
    };

    window.processInput = () => {
        const typedText = quoteInput.value;
        const targetChars = quoteDisplay.querySelectorAll('.char'); 

        let correctCount = 0;
        let isComplete = true;

        targetChars.forEach((charSpan, index) => {
            const char = charSpan.textContent === '\u00A0' ? ' ' : charSpan.textContent; 
            const typedChar = typedText[index];

            charSpan.classList.remove('correct', 'incorrect', 'current');

            if (typedChar === undefined) {
                isComplete = false;
                if (index === typedText.length) {
                    charSpan.classList.add('current'); 
                }
            } else if (typedChar === char) {
                charSpan.classList.add('correct');
                correctCount++;
            } else {
                charSpan.classList.add('incorrect');
                isComplete = false;
            }
        });
        
        // Cek jika selesai
        if (typedText.length === quoteToType.length && correctCount === quoteToType.length) {
            // Memastikan 100% benar sebelum menyelesaikan
            finishGame();
        } else if (typedText.length > quoteToType.length) {
             // Secara otomatis menyelesaikan jika terlalu panjang, meskipun ada kesalahan di tengah.
             // Namun, ini tidak akan dihitung selesai di loop if pertama.
             // Lebih baik membiarkan pengguna memperbaiki kesalahan ketik di akhir.
        }
    };
    
    const finishGame = () => {
        quoteInput.disabled = true;
        statusMessage.textContent = 'Selesai satu teks! Memuat teks baru...';
        
        // Tampilkan pesan sukses singkat
        alertMessage('Selesai diketik. Teks berganti otomatis!', 'success');
        
        setTimeout(() => {
            startGame(); // Mulai game baru secara otomatis
        }, 1000); 
    };

    // Pendaftaran fungsi global
    window.processInput = processInput;
    window.addText = addText;
    window.deleteText = deleteText;
    window.toggleManagementPanel = toggleManagementPanel;
    window.startGame = startGame; 

    window.onload = () => {
        managementPanel.classList.add('hidden'); 
    };

</script>

</body>
</html>
